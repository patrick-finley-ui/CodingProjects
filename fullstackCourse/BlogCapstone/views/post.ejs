<%- include("partials/header.ejs", {navLinks: navLinks}) %>

    <body>
        <div class="container">
            <h1 class="pt-5">
                <%= post.title %>
            </h1>
            <div class="post-content">
                <div class="ql-editor"><%- post.content %></div>
            </div>
            <div class="post-actions mb-4 mt-3">
                <a href="/" class="btn btn-primary me-2">
                    <i class="bi bi-arrow-left"></i> Back to Home
                </a>
                <a href="/edit/<%= post.id %>" class="btn btn-secondary me-2">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <!-- Delete Post Button with Confirmation -->
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Delete Post
                </button>
            </div>
        </div>

        <script>
            function confirmDelete() {
                if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                    // Clear previous logs
                    localStorage.removeItem('deleteLogs');
                    const logs = [];

                    function addLog(message, data = null) {
                        const logEntry = {
                            timestamp: new Date().toISOString(),
                            message: message,
                            data: data
                        };
                        logs.push(logEntry);
                        console.log(message, data);
                        localStorage.setItem('deleteLogs', JSON.stringify(logs));
                    }

                    addLog('Starting delete process...');
                    addLog('Post ID:', '<%= post.id %>');
                    addLog('Delete URL:', '/post/<%= post.id %>');

                    // Use Fetch API to send DELETE request
                    fetch('/post/<%= post.id %>', {
                        method: 'DELETE'
                    })
                        .then(response => {
                            addLog('Response received:', response);
                            addLog('Response status:', response.status);
                            addLog('Response ok:', response.ok);

                            return response.json(); // Parse JSON response
                        })
                        .then(data => {
                            addLog('Response data:', data);

                            if (data.success) {
                                addLog('Delete successful, redirecting...');
                                // Redirect to home page with success message
                                window.location.href = '/?deleted=true';
                            } else {
                                addLog('Delete failed:', data.message);
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            addLog('Fetch error:', error);
                            console.error('Fetch error:', error);
                            alert('Error deleting post. Please try again.');
                        });
                }
            }

            // Function to view stored logs (for debugging)
            function viewDeleteLogs() {
                const logs = JSON.parse(localStorage.getItem('deleteLogs') || '[]');
                console.log('=== STORED DELETE LOGS ===');
                logs.forEach(log => {
                    console.log(`[${log.timestamp}] ${log.message}`, log.data);
                });
            }

            // Make it available globally for debugging
            window.viewDeleteLogs = viewDeleteLogs;
        </script>
    </body>

    <%- include("partials/footer.ejs") %>